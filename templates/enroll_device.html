<!-- templates/enroll_device.html -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gerät registrieren – Namtaru MDM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
  <div class="container py-5">
    <div class="text-center mb-4">
      <h2>Gerät Registrierung</h2>
      <p>ID Token: <code>{{ token }}</code></p>
    </div>
    <div id="status" class="alert alert-info text-center" role="alert">
      Ermitteln der Geräte-Informationen...
    </div>
  </div>

  <script>
    // Gerätedaten sammeln
    const token = '{{ token }}';
    const payload = {
      token: token,
      platform: navigator.platform || 'unbekannt',
      type: navigator.userAgent.includes('Mobile') ? 'Smartphone' : 'Desktop',
      screen: `${screen.width}x${screen.height}`,
      user_agent: navigator.userAgent
    };

    // POST an /submit_device
    fetch('/submit_device', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      const statusEl = document.getElementById('status');
      if (data.success) {
        statusEl.className = 'alert alert-success text-center';
        statusEl.textContent = 'Gerät erfolgreich registriert! Weiterleitung in Kürze...';
        setTimeout(() => window.location.href = '/devices', 2000);
      } else {
        statusEl.className = 'alert alert-danger text-center';
        statusEl.textContent = 'Registrierung fehlgeschlagen. Bitte versuche es erneut.';
      }
    })
    .catch(err => {
      const statusEl = document.getElementById('status');
      statusEl.className = 'alert alert-danger text-center';
      statusEl.textContent = 'Netzwerk-Fehler beim Registrieren.';
      console.error(err);
    });
  </script>
</body>
</html>
